<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Lenormand LLM Reader <span class="pill">beta</span></h1>
      <p class="subtitle">ì§ˆë¬¸ì„ ì ê³  ìŠ¤í”„ë ˆë“œë¥¼ ì„ íƒí•˜ë©´, ë ˆë…¸ë¨¼ë“œ ì¹´ë“œì™€ í•¨ê»˜ LLM ë¦¬ë”©ì„ ë°›ì•„ë³¼ ìˆ˜ ìˆì–´ìš”.</p>

      <form id="reading-form">
        <label for="question">ì§ˆë¬¸ (í•œêµ­ì–´)</label>
        <textarea id="question" placeholder="ì˜ˆ: ì§€ê¸ˆ ì·¨ì—… ì¤€ë¹„ ë°©í–¥ì´ ë§ëŠ”ì§€ ì•Œê³  ì‹¶ì–´ìš”"></textarea>

        <label for="category">ì¹´í…Œê³ ë¦¬</label>
        <select id="category">
          <option value="">(ì„ íƒ ì•ˆ í•¨)</option>
          <option value="love">ì—°ì•  / ê´€ê³„</option>
          <option value="career">ì»¤ë¦¬ì–´</option>
          <option value="finance">ì¬ì •</option>
          <option value="self">ìê¸° ì´í•´</option>
          <option value="other">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option>
        </select>
        
        <div
          id="category-custom-wrapper"
          style="margin-top: 0.5rem; display: none;"
        >
          <input
            id="category-custom"
            type="text"
            class="input"
            placeholder="ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ ì§ì ‘ ì…ë ¥ (ì˜ˆ: ê±´ê°•, ê°€ì¡±, ì˜ì  ë“±)"
          />
        </div>

        <label for="spread">ìŠ¤í”„ë ˆë“œ</label>
        <select id="spread">
          <option value="single_card_yes_no">í•œ ì¥ ì˜ˆ/ì•„ë‹ˆì˜¤ (1ì¥)</option>
          <option value="past_present_future">ê³¼ê±°-í˜„ì¬-ë¯¸ë˜ (3ì¥)</option>
          <option value="situation_obstacle_advice">ìƒí™©-ì¥ì• -ì¡°ì–¸ (3ì¥)</option>
          <option value="nine_box">3x3 ë°•ìŠ¤ (9ì¥)</option>
          <option value="grand_tableau_8x4_plus4">ê·¸ë‘ í…Œì´ë¸”ë¡œ (36ì¥)</option>
        </select>

        <div id="querent-wrapper" style="display: none; margin-top: 8px;">
          <label for="querent-card">ì§ˆë¬¸ì ì¹´ë“œ (GT ì „ìš©)</label>
          <select id="querent-card">
            <option value="">ì„ íƒ ì•ˆ í•¨</option>
            <option value="man">ë‚¨ì„± (Man ì¹´ë“œ)</option>
            <option value="woman">ì—¬ì„± (Woman ì¹´ë“œ)</option>
          </select>
        </div>

        <button type="submit">ë¦¬ë”© ìš”ì²­í•˜ê¸° ğŸ”®</button>
        <div id="status" class="loading" style="display:none;">ì¹´ë“œë¥¼ ì„ëŠ” ì¤‘...</div>
        <div id="error" class="error" style="display:none;"></div>
      </form>
    </div>


      <div class="card">
        <div class="section-title">ì¹´ë“œ ë°°ì—´</div>
        <div id="cards-container" class="cards-grid"></div>
      </div>

    <div id="result" style="display:none;">
      <div class="card">
        <div id="summary-block">
          <div class="section-title">ìš”ì•½</div>
          <p id="summary-text"></p>
        </div>
        <div style="margin-top: 1rem;">
          <div class="section-title">ì „ì²´ íë¦„</div>
          <p id="overall-text"></p>
        </div>
        <div style="margin-top: 1rem;">
          <div class="section-title">ì¶”ì²œ í–‰ë™</div>
          <ul id="actions-list" class="action-list"></ul>
        </div>
        <div style="margin-top: 1rem;">
          <div class="section-title">ë¦¬ë” ì°¸ê³  ë…¸íŠ¸</div>
          <div id="reader-notes-box" class="reader-notes"></div>
        </div>
        <p class="small" id="spread-label"></p>
      </div>
  </div>

  <script>
    const form = document.getElementById("reading-form");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const resultEl = document.getElementById("result");
    const querentSelect = document.getElementById("querent-card");
    const querentWrapper = document.getElementById("querent-wrapper");
    let currentQuerentCardId = null;
  

    const summaryText = document.getElementById("summary-text");
    const readerNotesBox = document.getElementById("reader-notes-box");
    const overallText = document.getElementById("overall-text");
    const actionsList = document.getElementById("actions-list");
    const cardsContainer = document.getElementById("cards-container");
    const spreadLabel = document.getElementById("spread-label");

    // ğŸ”¹ ì¹´í…Œê³ ë¦¬ ê´€ë ¨ ìš”ì†Œë“¤ (ì „ì—­ì—ì„œ í•œ ë²ˆë§Œ ì¡ê¸°)
    const categorySelect = document.getElementById("category");
    const categoryCustomWrapper = document.getElementById("category-custom-wrapper");
    const categoryCustom = document.getElementById("category-custom");

    // ğŸ”¹ ìŠ¤í”„ë ˆë“œ / ì§ˆë¬¸ì ì¹´ë“œ ê´€ë ¨
    const spreadSelect = document.getElementById("spread");
    spreadSelect.addEventListener("change", updateQuerentVisibility);
    updateQuerentVisibility();

    
    // ğŸ”¹ ê¸°íƒ€(ì§ì ‘ ì…ë ¥) ì„ íƒí–ˆì„ ë•Œë§Œ input ë³´ì´ê²Œ
    function updateCategoryInputVisibility() {
      if (categorySelect.value === "other") {
        categoryCustomWrapper.style.display = "block";
      } else {
        categoryCustomWrapper.style.display = "none";
        categoryCustom.value = ""; // ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¡œ ë°”ê¾¸ë©´ ì…ë ¥ê°’ ë¹„ìš°ê¸°
      }
    }

    function updateQuerentVisibility() {
      if (spreadSelect.value === "grand_tableau_8x4_plus4") {
        // GTì¼ ë•Œë§Œ ë³´ì´ê¸°
        querentWrapper.style.display = "block";
      } else {
        // ë‹¤ë¥¸ ìŠ¤í”„ë ˆë“œì¼ ë•ŒëŠ” ìˆ¨ê¸°ê³  ì„ íƒ ì´ˆê¸°í™”
        querentWrapper.style.display = "none";
        querentSelect.value = "";
        currentQuerentCardId = null;
      }
    }


    // í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆ, ê°’ ë°”ë€” ë•Œë§ˆë‹¤ í•œ ë²ˆ
    updateCategoryInputVisibility();
    categorySelect.addEventListener("change", updateCategoryInputVisibility);

    function loadCardImage(imgEl, cardId) {
      const webp = `/static/cards/${cardId}.webp`;
      const png = `/static/cards/${cardId}.png`;

      imgEl.src = webp;

      imgEl.onerror = () => {
        // webp ì—†ìœ¼ë©´ png ì‹œë„
        imgEl.onerror = () => {
          // pngë„ ì—†ìœ¼ë©´ ì´ë¯¸ì§€ ìˆ¨ê¹€
          imgEl.style.display = "none";
        };
        imgEl.src = png;
      };
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorEl.style.display = "none";
      resultEl.style.display = "none";
      statusEl.style.display = "block";
      statusEl.textContent = "ì¹´ë“œë¥¼ ì„ëŠ” ì¤‘...";

      const question = document.getElementById("question").value.trim();

        // ì§ˆë¬¸ì ì¹´ë“œ ì„ íƒê°’ â†’ ì¹´ë“œ ë²ˆí˜¸ë¡œ ë§¤í•‘
      const qc = querentSelect.value; // "", "man", "woman"
      if (qc === "man") {
        currentQuerentCardId = 28; // Man
      } else if (qc === "woman") {
        currentQuerentCardId = 29; // Woman
      } else {
        currentQuerentCardId = null;
      }

      // ğŸ”¹ ì¹´í…Œê³ ë¦¬ ê°’ ê²°ì • (select + ê¸°íƒ€ ì…ë ¥ì¹¸)
      let category = categorySelect.value;
      if (category === "other") {
        category = categoryCustom.value.trim() || "other";
      }

      const spread = document.getElementById("spread").value;

      if (!question) {
        statusEl.style.display = "none";
        errorEl.style.display = "block";
        errorEl.textContent = "ì§ˆë¬¸ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.";
        return;
      }

      try {
        const res = await fetch("/api/reading", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            question_ko: question,
            category: category || null,
            spread_type: spread
          }),
        });

        if (!res.ok) {
          throw new Error("ì„œë²„ ì˜¤ë¥˜: " + res.status);
        }

        const data = await res.json();
        statusEl.style.display = "none";
        renderResult(data);
      } catch (err) {
        console.error(err);
        statusEl.style.display = "none";
        errorEl.style.display = "block";
        errorEl.textContent = "ë¦¬ë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.";
      }
    });

    function renderResult(data) {
      resultEl.style.display = "block";

      const spreadType = data.spread_type || "";

      const rk = data.reading_ko || {};
      summaryText.textContent = rk.summary_ko || "(ìš”ì•½ ì •ë³´ ì—†ìŒ)";
      overallText.textContent = rk.overall_story_ko || "(ì „ì²´ ì„¤ëª… ì—†ìŒ)";

      // í–‰ë™ ë¦¬ìŠ¤íŠ¸
      actionsList.innerHTML = "";
      const actions = rk.action_items_ko || [];
      actions.forEach((item) => {
        const li = document.createElement("li");
        li.textContent = item;
        actionsList.appendChild(li);
      });

      // ìŠ¤í”„ë ˆë“œ ì •ë³´
      spreadLabel.textContent = `ìŠ¤í”„ë ˆë“œ: ${data.spread_type || ""}`;

      // ì¹´ë“œë“¤
      // ì¹´ë“œë“¤
      cardsContainer.innerHTML = "";
      const cards = data.cards || [];

      // ë¨¼ì € ì˜ˆì „ í´ë˜ìŠ¤ë“¤ ì‹¹ ì œê±°
      cardsContainer.classList.remove("cards-grid--3", "cards-grid--9", "cards-grid--gt");

      // ì¹´ë“œ ê°œìˆ˜ì— ë”°ë¼ ë ˆì´ì•„ì›ƒ í´ë˜ìŠ¤ ë¶™ì´ê¸°
      if (cards.length === 3) {
        // ê³¼ê±°-í˜„ì¬-ë¯¸ë˜ / ìƒí™©-ì¥ì• -ì¡°ì–¸
        cardsContainer.classList.add("cards-grid--3");
      } else if (cards.length === 9) {
        // 3x3 ë°•ìŠ¤
        cardsContainer.classList.add("cards-grid--9");
      } else if (cards.length === 36) {
        // ê·¸ë‘ í…Œì´ë¸”ë¡œ
        cardsContainer.classList.add("cards-grid--gt");
      }
      // 1ì¥ ì˜ˆ/ì•„ë‹ˆì˜¤ëŠ” ì•„ë¬´ í´ë˜ìŠ¤ë„ ì•ˆ ë¶™ì„ (ê¸°ë³¸ 1ì—´)


      // ì¹´ë“œ ë°°ì—´ ë Œë”ë§
            // ì¹´ë“œ ë°°ì—´ ë Œë”ë§
      cards.forEach((c) => {
        const div = document.createElement("div");
        div.className = "card-item";


        // ğŸ”¹ GT ìœ„ì¹˜ ì§€ì •
        if (spreadType === "grand_tableau_8x4_plus4") {
          // row/columnì´ ì–´ë”” ë“¤ì–´ìˆë“  ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
          const row = c.row || c.position_row || c.position?.row;
          const col = c.column || c.position_column || c.position?.column;

          if (row && col) {
            div.style.gridRow = row;
            div.style.gridColumn = col;
          }
        }


        // ğŸ”¹ GT + ì§ˆë¬¸ì ì¹´ë“œ ì„ íƒëœ ê²½ìš° â†’ í•˜ì´ë¼ì´íŠ¸
        if (
          data.spread_type === "grand_tableau_8x4_plus4" &&
          currentQuerentCardId &&
          c.card_id === currentQuerentCardId
        ) {
          div.classList.add("querent-highlight");
        }

        // 1) ì¹´ë“œ ì´ë¯¸ì§€
        const img = document.createElement("img");
        img.className = "card-img";
        loadCardImage(img, c.card_id);
        div.appendChild(img);

        // 2) í¬ì§€ì…˜ ë¼ë²¨
        const pos = document.createElement("div");
        pos.className = "card-position";
        pos.textContent = c.position_label_ko || c.position_key || "";

        // 3) ì¹´ë“œ ì´ë¦„
        const name = document.createElement("div");
        name.className = "card-name";
        name.textContent = `${c.name_ko || ""} / ${c.name_en || ""}`;

        // 4) ê¸°ë³¸ ì˜ë¯¸
        const meaning = document.createElement("div");
        meaning.className = "card-meaning";
        meaning.textContent = c.interpretation_ko || "(ê¸°ë³¸ ì˜ë¯¸ ì—†ìŒ)";

        div.appendChild(pos);
        div.appendChild(name);
        div.appendChild(meaning);

        cardsContainer.appendChild(div);
      });


      // ğŸ”¹ ë¦¬ë” ì°¸ê³  ë…¸íŠ¸ (ì¹´ë“œë³„)
      readerNotesBox.innerHTML = "";
      let hasNotes = false;

      (data.cards || []).forEach((c) => {
        if (!c.reader_note) return;

        hasNotes = true;
        const block = document.createElement("div");
        block.className = "reader-note-block";

        const title = document.createElement("div");
        title.className = "reader-note-title";
        title.textContent = c.name_ko || c.name_en || "";

        const body = document.createElement("div");
        body.innerHTML = (c.reader_note || "").replace(/\n/g, "<br>");

        block.appendChild(title);
        block.appendChild(body);
        readerNotesBox.appendChild(block);
      });

      if (!hasNotes) {
        readerNotesBox.parentElement.style.display = "none";
      } else {
        readerNotesBox.parentElement.style.display = "block";
      }
    }
  </script>

</body>
</html>
