<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Lenormand LLM Reader</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* ìŠ¤íƒ€ì¼ íŒŒì¼ ë”°ë¡œ ì“°ê¸° ê·€ì°®ìœ¼ë©´ ì—¬ê¸°ì„œ ë°”ë¡œ ì¨ë„ ë¨ */

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #f9f5ff, #e5e7eb);
      margin: 0;
      padding: 0;
      color: #111827;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem 3rem;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 2rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .reader-notes {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed #e5e7eb;
      font-size: 0.85rem;
      color: #4b5563;
    }

    .reader-note-block {
      margin-bottom: 0.75rem;
    }

    .reader-note-title {
      font-weight: 600;
      margin-bottom: 0.2rem;
    }


    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    textarea, select, button, input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 0.6rem 0.75rem;
      border-radius: 0.6rem;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      margin-bottom: 1rem;
      outline: none;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    textarea:focus,
    select:focus,
    input[type="text"]:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3);
    }

    button {
      background: linear-gradient(135deg, #6366f1, #ec4899);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      margin-top: 0.5rem;
    }

    button:hover {
      filter: brightness(1.05);
    }

    .cards-grid {
      display: grid;
      gap: 1rem;
    }

    /* 3ì¥ ìŠ¤í”„ë ˆë“œì¼ ë•Œ ê°€ë¡œë¡œ */
    .cards-grid--3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .card-item {
      background: white;
      border-radius: 0.75rem;
      padding: 0.9rem;
      border: 1px solid rgba(209, 213, 219, 0.9);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }

    .card-position {
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #6b7280;
      margin-bottom: 0.25rem;
    }

    .card-name {
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .card-meaning {
      font-size: 0.9rem;
      color: #4b5563;
    }

    .section-title {
      font-weight: 700;
      margin-bottom: 0.3rem;
    }

    .action-list {
      padding-left: 1.1rem;
      margin: 0.2rem 0 0;
      color: #4b5563;
    }

    .pill {
      display: inline-block;
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      margin-left: 0.4rem;
      vertical-align: middle;
    }

    .small {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .loading {
      font-size: 0.9rem;
      color: #6b7280;
    }

    .error {
      font-size: 0.9rem;
      color: #b91c1c;
      margin-top: 0.5rem;
    }

    .card-img {
      width: 100%;
      border-radius: 0.6rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Lenormand LLM Reader <span class="pill">beta</span></h1>
      <p class="subtitle">ì§ˆë¬¸ì„ ì ê³  ìŠ¤í”„ë ˆë“œë¥¼ ì„ íƒí•˜ë©´, ë ˆë…¸ë¨¼ë“œ ì¹´ë“œì™€ í•¨ê»˜ LLM ë¦¬ë”©ì„ ë°›ì•„ë³¼ ìˆ˜ ìˆì–´ìš”.</p>

      <form id="reading-form">
        <label for="question">ì§ˆë¬¸ (í•œêµ­ì–´)</label>
        <textarea id="question" placeholder="ì˜ˆ: ì§€ê¸ˆ ì·¨ì—… ì¤€ë¹„ ë°©í–¥ì´ ë§ëŠ”ì§€ ì•Œê³  ì‹¶ì–´ìš”"></textarea>

        <label for="category">ì¹´í…Œê³ ë¦¬</label>
        <select id="category">
          <option value="">(ì„ íƒ ì•ˆ í•¨)</option>
          <option value="love">ì—°ì•  / ê´€ê³„</option>
          <option value="career">ì»¤ë¦¬ì–´</option>
          <option value="finance">ì¬ì •</option>
          <option value="self">ìê¸° ì´í•´</option>
          <option value="other">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option>
        </select>
        
        <div
          id="category-custom-wrapper"
          style="margin-top: 0.5rem; display: none;"
        >
          <input
            id="category-custom"
            type="text"
            class="input"
            placeholder="ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ ì§ì ‘ ì…ë ¥ (ì˜ˆ: ê±´ê°•, ê°€ì¡±, ì˜ì  ë“±)"
          />
        </div>

        <label for="spread">ìŠ¤í”„ë ˆë“œ</label>
        <select id="spread">
          <option value="single_card_yes_no">í•œ ì¥ ì˜ˆ/ì•„ë‹ˆì˜¤ (1ì¥)</option>
          <option value="past_present_future">ê³¼ê±°-í˜„ì¬-ë¯¸ë˜ (3ì¥)</option>
          <option value="situation_obstacle_advice">ìƒí™©-ì¥ì• -ì¡°ì–¸ (3ì¥)</option>
          <option value="nine_box">3x3 ë°•ìŠ¤ (9ì¥)</option>
          <option value="grand_tableau_8x4_plus4">ê·¸ë‘ í…Œì´ë¸”ë¡œ (36ì¥)</option>
        </select>

        <button type="submit">ë¦¬ë”© ìš”ì²­í•˜ê¸° ğŸ”®</button>
        <div id="status" class="loading" style="display:none;">ì¹´ë“œë¥¼ ì„ëŠ” ì¤‘...</div>
        <div id="error" class="error" style="display:none;"></div>
      </form>
    </div>

      <div class="card">
        <div class="section-title">ì¹´ë“œ ë°°ì—´</div>
        <div id="cards-container" class="cards-grid"></div>
      </div>

    <div id="result" style="display:none;">
      <div class="card">
        <div id="summary-block">
          <div class="section-title">ìš”ì•½</div>
          <p id="summary-text"></p>
        </div>
        <div style="margin-top: 1rem;">
          <div class="section-title">ì „ì²´ íë¦„</div>
          <p id="overall-text"></p>
        </div>
        <div style="margin-top: 1rem;">
          <div class="section-title">ì¶”ì²œ í–‰ë™</div>
          <ul id="actions-list" class="action-list"></ul>
        </div>
        <div style="margin-top: 1rem;">
          <div class="section-title">ë¦¬ë” ì°¸ê³  ë…¸íŠ¸</div>
          <div id="reader-notes-box" class="reader-notes"></div>
        </div>
        <p class="small" id="spread-label"></p>
      </div>
  </div>

  <script>
    const form = document.getElementById("reading-form");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const resultEl = document.getElementById("result");

    const summaryText = document.getElementById("summary-text");
    const readerNotesBox = document.getElementById("reader-notes-box");
    const overallText = document.getElementById("overall-text");
    const actionsList = document.getElementById("actions-list");
    const cardsContainer = document.getElementById("cards-container");
    const spreadLabel = document.getElementById("spread-label");

    // ğŸ”¹ ì¹´í…Œê³ ë¦¬ ê´€ë ¨ ìš”ì†Œë“¤ (ì „ì—­ì—ì„œ í•œ ë²ˆë§Œ ì¡ê¸°)
    const categorySelect = document.getElementById("category");
    const categoryCustomWrapper = document.getElementById("category-custom-wrapper");
    const categoryCustom = document.getElementById("category-custom");

    // ğŸ”¹ ê¸°íƒ€(ì§ì ‘ ì…ë ¥) ì„ íƒí–ˆì„ ë•Œë§Œ input ë³´ì´ê²Œ
    function updateCategoryInputVisibility() {
      if (categorySelect.value === "other") {
        categoryCustomWrapper.style.display = "block";
      } else {
        categoryCustomWrapper.style.display = "none";
        categoryCustom.value = ""; // ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¡œ ë°”ê¾¸ë©´ ì…ë ¥ê°’ ë¹„ìš°ê¸°
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆ, ê°’ ë°”ë€” ë•Œë§ˆë‹¤ í•œ ë²ˆ
    updateCategoryInputVisibility();
    categorySelect.addEventListener("change", updateCategoryInputVisibility);

    function loadCardImage(imgEl, cardId) {
      const webp = `/static/cards/${cardId}.webp`;
      const png = `/static/cards/${cardId}.png`;

      imgEl.src = webp;

      imgEl.onerror = () => {
        // webp ì—†ìœ¼ë©´ png ì‹œë„
        imgEl.onerror = () => {
          // pngë„ ì—†ìœ¼ë©´ ì´ë¯¸ì§€ ìˆ¨ê¹€
          imgEl.style.display = "none";
        };
        imgEl.src = png;
      };
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorEl.style.display = "none";
      resultEl.style.display = "none";
      statusEl.style.display = "block";
      statusEl.textContent = "ì¹´ë“œë¥¼ ì„ëŠ” ì¤‘...";

      const question = document.getElementById("question").value.trim();

      // ğŸ”¹ ì¹´í…Œê³ ë¦¬ ê°’ ê²°ì • (select + ê¸°íƒ€ ì…ë ¥ì¹¸)
      let category = categorySelect.value;
      if (category === "other") {
        category = categoryCustom.value.trim() || "other";
      }

      const spread = document.getElementById("spread").value;

      if (!question) {
        statusEl.style.display = "none";
        errorEl.style.display = "block";
        errorEl.textContent = "ì§ˆë¬¸ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.";
        return;
      }

      try {
        const res = await fetch("/api/reading", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            question_ko: question,
            category: category || null,
            spread_type: spread
          }),
        });

        if (!res.ok) {
          throw new Error("ì„œë²„ ì˜¤ë¥˜: " + res.status);
        }

        const data = await res.json();
        statusEl.style.display = "none";
        renderResult(data);
      } catch (err) {
        console.error(err);
        statusEl.style.display = "none";
        errorEl.style.display = "block";
        errorEl.textContent = "ë¦¬ë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.";
      }
    });

    function renderResult(data) {
      resultEl.style.display = "block";

      const rk = data.reading_ko || {};
      summaryText.textContent = rk.summary_ko || "(ìš”ì•½ ì •ë³´ ì—†ìŒ)";
      overallText.textContent = rk.overall_story_ko || "(ì „ì²´ ì„¤ëª… ì—†ìŒ)";

      // í–‰ë™ ë¦¬ìŠ¤íŠ¸
      actionsList.innerHTML = "";
      const actions = rk.action_items_ko || [];
      actions.forEach((item) => {
        const li = document.createElement("li");
        li.textContent = item;
        actionsList.appendChild(li);
      });

      // ìŠ¤í”„ë ˆë“œ ì •ë³´
      spreadLabel.textContent = `ìŠ¤í”„ë ˆë“œ: ${data.spread_type || ""}`;

      // ì¹´ë“œë“¤
      cardsContainer.innerHTML = "";
      const cards = data.cards || [];

      // 3ì¥ ìŠ¤í”„ë ˆë“œë©´ ê°€ë¡œ 3ì—´, ì•„ë‹ˆë©´ ìë™
      if (cards.length === 3) {
        cardsContainer.classList.add("cards-grid--3");
      } else {
        cardsContainer.classList.remove("cards-grid--3");
      }

      // ì¹´ë“œ ë°°ì—´ ë Œë”ë§
      cards.forEach((c) => {
        const div = document.createElement("div");
        div.className = "card-item";

        // 1) ì¹´ë“œ ì´ë¯¸ì§€
        const img = document.createElement("img");
        img.className = "card-img";
        loadCardImage(img, c.card_id);
        div.appendChild(img);

        // 2) í¬ì§€ì…˜ ë¼ë²¨
        const pos = document.createElement("div");
        pos.className = "card-position";
        pos.textContent = c.position_label_ko || c.position_key || "";

        // 3) ì¹´ë“œ ì´ë¦„
        const name = document.createElement("div");
        name.className = "card-name";
        name.textContent = `${c.name_ko || ""} / ${c.name_en || ""}`;

        // 4) ê¸°ë³¸ ì˜ë¯¸
        const meaning = document.createElement("div");
        meaning.className = "card-meaning";
        meaning.textContent = c.interpretation_ko || "(ê¸°ë³¸ ì˜ë¯¸ ì—†ìŒ)";

        div.appendChild(pos);
        div.appendChild(name);
        div.appendChild(meaning);

        cardsContainer.appendChild(div);
      });

      // ğŸ”¹ ë¦¬ë” ì°¸ê³  ë…¸íŠ¸ (ì¹´ë“œë³„)
      readerNotesBox.innerHTML = "";
      let hasNotes = false;

      (data.cards || []).forEach((c) => {
        if (!c.reader_note) return;

        hasNotes = true;
        const block = document.createElement("div");
        block.className = "reader-note-block";

        const title = document.createElement("div");
        title.className = "reader-note-title";
        title.textContent = c.name_ko || c.name_en || "";

        const body = document.createElement("div");
        body.innerHTML = (c.reader_note || "").replace(/\n/g, "<br>");

        block.appendChild(title);
        block.appendChild(body);
        readerNotesBox.appendChild(block);
      });

      if (!hasNotes) {
        readerNotesBox.parentElement.style.display = "none";
      } else {
        readerNotesBox.parentElement.style.display = "block";
      }
    }
  </script>

</body>
</html>
